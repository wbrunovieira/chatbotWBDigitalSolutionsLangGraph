---
# Quick deploy: git pull → rebuild → restart
# Usage: cd ansible && ansible-playbook -i inventory.ini quick-deploy.yml
- name: Quick deploy Chatbot
  hosts: chatbot_server
  gather_facts: false

  vars:
    app_dir: /root/chatbot
    repo_url: https://github.com/wbrunovieira/chatbotWBDigitalSolutionsLangGraph.git
    git_branch: main
    compose_file: docker-compose.yml

  tasks:
    - name: Ensure git safe.directory
      raw: git config --global --add safe.directory {{ app_dir }}
      changed_when: false

    - name: Backup .env before git operations
      raw: cp {{ app_dir }}/.env {{ app_dir }}/.env.bak 2>/dev/null; echo "ok"
      changed_when: false

    - name: Check if git repo exists
      raw: test -d {{ app_dir }}/.git && echo "YES" || echo "NO"
      register: git_exists
      changed_when: false

    - name: Clone repo (first time only)
      raw: |
        tmp=$(mktemp -d) && \
        git clone --branch {{ git_branch }} {{ repo_url }} "$tmp" && \
        mv "$tmp/.git" {{ app_dir }}/.git && \
        rm -rf "$tmp" && \
        cd {{ app_dir }} && git reset --hard origin/{{ git_branch }} 2>&1
      when: "'NO' in git_exists.stdout"
      register: git_clone_result

    - name: Show clone output
      raw: echo "{{ git_clone_result.stdout_lines | default(['skipped']) | join('\n') }}"
      when: git_clone_result is not skipped
      changed_when: false

    - name: Pull latest code
      raw: |
        cd {{ app_dir }} && git fetch origin {{ git_branch }} && git reset --hard origin/{{ git_branch }} 2>&1
      register: git_result

    - name: Show git changes
      raw: echo "{{ git_result.stdout_lines | default(['no output']) | join('\n') }}"
      changed_when: false

    - name: Restore .env
      raw: |
        cp {{ app_dir }}/.env.bak {{ app_dir }}/.env 2>/dev/null
        echo ".env restored"
      changed_when: false

    - name: Rebuild and restart chatbot container
      raw: |
        cd {{ app_dir }} && docker compose -f {{ compose_file }} up -d --build chatbot 2>&1
      register: compose_result

    - name: Show compose output
      raw: echo "{{ compose_result.stdout_lines | default(['no output']) | join('\n') }}"
      changed_when: false

    - name: Restart qdrant and redis (pick up healthcheck changes)
      raw: |
        cd {{ app_dir }} && docker compose -f {{ compose_file }} up -d qdrant redis-chatbot 2>&1
      register: infra_result

    - name: Show infra output
      raw: echo "{{ infra_result.stdout_lines | default(['no output']) | join('\n') }}"
      changed_when: false

    - name: Wait for containers to stabilize
      raw: sleep 15
      changed_when: false

    - name: Health check — all services
      raw: |
        echo "chatbot_app:    $(curl -sf -o /dev/null -w '%{http_code}' http://127.0.0.1:8001/health || echo 'DOWN')"
        echo "chatbot_qdrant: $(curl -sf -o /dev/null -w '%{http_code}' http://127.0.0.1:6333/readyz || echo 'DOWN')"
        echo "chatbot_redis:  $(docker exec chatbot_redis redis-cli ping 2>/dev/null || echo 'DOWN')"
      changed_when: false

    - name: Show container status
      raw: |
        cd {{ app_dir }} && docker compose -f {{ compose_file }} ps --format "table {% raw %}{{.Name}}\t{{.Status}}{% endraw %}" 2>/dev/null || docker compose -f {{ compose_file }} ps
      changed_when: false
